name: Update Release Notes (README + CHANGELOG)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to update (e.g. v1.1.2)"
        required: true
        type: string

permissions:
  contents: write

jobs:
  update_notes:
    name: Update notes for tag
    runs-on: ubuntu-latest
    env:
      TAG_NAME: ${{ github.event.inputs.tag }}
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout (for CHANGELOG.md)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ env.TAG_NAME }}

      - name: Generate notes from README + CHANGELOG
        run: |
          python3 - <<'PY'
          from __future__ import annotations
          from pathlib import Path
          import os
          import re

          tag = (os.environ.get("TAG_NAME") or "").strip()
          repo = (os.environ.get("GITHUB_REPOSITORY") or "").strip()
          readme_url = f"https://github.com/{repo}#readme" if repo else ""
          version = tag[1:] if tag.startswith("v") else tag

          readme = Path("README.md")
          changelog = Path("CHANGELOG.md")
          out = Path("release_body.md")

          def _extract_readme_section(readme_lines: list[str], heading: str) -> str:
              start = None
              for i, ln in enumerate(readme_lines):
                  if ln.strip() == heading:
                      start = i
                      break
              if start is None:
                  return ""

              end = len(readme_lines)
              for j in range(start + 1, len(readme_lines)):
                  s = readme_lines[j].strip()
                  if s == "---":
                      end = j
                      break
                  if heading.startswith("# ") and s.startswith("# "):
                      end = j
                      break
                  if heading.startswith("## ") and s.startswith("## "):
                      end = j
                      break
              return "\n".join(readme_lines[start:end]).rstrip() + "\n"

          def _extract_changelog_section(changelog_lines: list[str], version_str: str) -> str:
              header_re = re.compile(r"^##\s+\[" + re.escape(version_str) + r"\](?:\s|$)")
              any_header_re = re.compile(r"^##\s+\[")

              start = None
              for i, ln in enumerate(changelog_lines):
                  if header_re.match(ln.strip()):
                      start = i
                      break
              if start is None:
                  return ""

              end = len(changelog_lines)
              for j in range(start + 1, len(changelog_lines)):
                  if any_header_re.match(changelog_lines[j].strip()):
                      end = j
                      break
              return "\n".join(changelog_lines[start:end]).rstrip() + "\n"

          readme_lines = readme.read_text(encoding="utf-8").splitlines() if readme.exists() else []
          changelog_lines = changelog.read_text(encoding="utf-8").splitlines() if changelog.exists() else []

          intro = _extract_readme_section(readme_lines, "# CAN Analyzer")
          features = _extract_readme_section(readme_lines, "## Features")
          changes = _extract_changelog_section(changelog_lines, version)

          parts = []
          if intro:
              parts.append(intro)
          if features:
              parts.append(features)
          if readme_url:
              parts.append(f"For more information: {readme_url}\n")
          if changes:
              parts.append("## Changelog\n\n" + changes)
          else:
              parts.append(f"## Changelog\n\n(Notes not found in CHANGELOG.md for {tag}.)\n")

          body = "\n\n---\n\n".join(p.strip() for p in parts if p.strip()) + "\n"
          out.write_text(body, encoding="utf-8")
          print(f"Wrote {out} for {tag} (len={len(body)})")
          PY

      - name: Update GitHub Release description (no build)
        run: |
          gh release edit "$TAG_NAME" --notes-file release_body.md

